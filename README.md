# AmoCRM Integration Service

–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∞ –ò–ò. –î–ª—è —Ä–∞–±–æ—Ç—ã –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–æ–ª–≥–æ—Å—Ä–æ—á–Ω—ã–π —Ç–æ–∫–µ–Ω, –∫–æ—Ç–æ—Ä—ã–π –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –≤ env —Ñ–∞–π–ª –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é AMO_ACCESS_TOKEN. –î–∞–ª—å—à–µ –≤—Å—ë –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–±–æ—Ä–∫—É.

–í–æ–∑–Ω–∏–∫–ª–∏ –ø—Ä–æ–±–ª–µ–º—ã —Å ngrok, –æ—Ç–∫–∞–∑–∞–ª—Å—è —Ä–∞–±–æ—Ç–∞—Ç—å —Å –º–æ–µ–≥–æ –∞–¥—Ä–µ—Å–∞, –ø–æ—ç—Ç–æ–º—É –Ω–µ –¥–æ–±–∞–≤–ª—è–ª —Ä–∞–±–æ—Ç—É —Å —Ç–æ–∫–µ–Ω–∞–º–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏.

–°–µ—Ä–≤–∏—Å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å AmoCRM –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è –∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ –∏ —Å–¥–µ–ª–æ–∫.

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

–ü—Ä–æ–µ–∫—Ç –ø–æ—Å—Ç—Ä–æ–µ–Ω –Ω–∞ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–º —Å—Ç–µ–∫–µ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π:

- **Backend**: Node.js + TypeScript + Express.js
- **–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö**: MySQL 8.0 + Drizzle ORM
- **DI –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä**: Inversify
- **–í–∞–ª–∏–¥–∞—Ü–∏—è**: Zod
- **–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä–∏–∑–∞—Ü–∏—è**: Docker + Docker Compose
- **–ü—Ä–æ–∫—Å–∏-—Å–µ—Ä–≤–µ—Ä**: Nginx

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
amo_test/
‚îú‚îÄ‚îÄ backend/                 # Backend –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
‚îÇ   ‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ config/         # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (Inversify, env)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ controllers/    # –ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä—ã (Contact, Lead, AmoCRM)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ services/       # –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ repositories/   # –°–ª–æ–π –¥–æ—Å—Ç—É–ø–∞ –∫ –¥–∞–Ω–Ω—ã–º
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ models/         # –ú–æ–¥–µ–ª–∏ –¥–∞–Ω–Ω—ã—Ö
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ database/       # –°—Ö–µ–º–∞ –ë–î –∏ –º–∏–≥—Ä–∞—Ü–∏–∏
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ main.ts         # –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞
‚îÇ   ‚îú‚îÄ‚îÄ Dockerfile          # Docker –æ–±—Ä–∞–∑ –¥–ª—è backend
‚îÇ   ‚îú‚îÄ‚îÄ start.sh            # –°–∫—Ä–∏–ø—Ç –∑–∞–ø—É—Å–∫–∞ —Å –º–∏–≥—Ä–∞—Ü–∏—è–º–∏
‚îÇ   ‚îî‚îÄ‚îÄ paths.js            # –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –∞–ª–∏–∞—Å–æ–≤ TypeScript
‚îú‚îÄ‚îÄ nginx/                   # Nginx –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
‚îú‚îÄ‚îÄ docker-compose.yml       # –û—Ä–∫–µ—Å—Ç—Ä–∞—Ü–∏—è —Å–µ—Ä–≤–∏—Å–æ–≤
‚îî‚îÄ‚îÄ hooks.rest              # –¢–µ—Å—Ç–æ–≤—ã–µ –∑–∞–ø—Ä–æ—Å—ã –¥–ª—è webhook'–æ–≤
```

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è

- Docker –∏ Docker Compose

### 1. –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞

```bash
git clone https://github.com/ShaevAndr/amo-test.git
cd amo_test
```

### 2. –°–æ–∑–¥–∞–Ω–∏–µ .env —Ñ–∞–π–ª–∞

–°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª `.env` –≤ –∫–æ—Ä–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞:

```env
# –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
DB_HOST=localhost
DB_HOST_DOCKER=db
DB_PORT=3306
DB_USER=amo_user
DB_PASSWORD=amo_password
DB_NAME=amo_db
MYSQL_ROOT_PASSWORD=root_password

# –°–µ—Ä–≤–µ—Ä
PORT=3000
SERVER_URL=http://localhost

# AmoCRM
AMO_CLIENT_ID=your_client_id
AMO_CLIENT_SECRET=your_client_secret
AMO_REDIRECT_URI=http://localhost/oauth/callback
AMO_DOMAIN=your_domain.amocrm.ru
AMO_ACCESS_TOKEN=your_long_lived_token
```

### 3. –ó–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ Docker Compose

```bash
# –°–±–æ—Ä–∫–∞ –∏ –∑–∞–ø—É—Å–∫ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
docker compose up --build

# –ó–∞–ø—É—Å–∫ –≤ —Ñ–æ–Ω–æ–≤–æ–º —Ä–µ–∂–∏–º–µ
docker compose up -d --build

# –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤
docker compose logs -f backend
```

````

## üõ†Ô∏è –õ–æ–∫–∞–ª—å–Ω–∞—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞

### –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

```bash
cd backend
npm install
````

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

```bash
# –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü
npm run migrate

# –ò–ª–∏ —á–µ—Ä–µ–∑ Drizzle Kit
npx drizzle-kit migrate
```

### –ó–∞–ø—É—Å–∫ –≤ —Ä–µ–∂–∏–º–µ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏

```bash
# –ó–∞–ø—É—Å–∫ —Å hot reload
npm run dev

# –°–±–æ—Ä–∫–∞ –∏ –∑–∞–ø—É—Å–∫
npm run build
npm start
```

## üìä API Endpoints

### –ö–æ–Ω—Ç–∞–∫—Ç—ã

- `POST /api/contacts` - –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω—Ç–∞–∫—Ç–∞
- `GET /api/contacts/:id` - –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–æ–Ω—Ç–∞–∫—Ç–∞ –ø–æ ID
- `PUT /api/contacts/:id` - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç–∞–∫—Ç–∞

### –°–¥–µ–ª–∫–∏

- `POST /api/leads` - –°–æ–∑–¥–∞–Ω–∏–µ —Å–¥–µ–ª–∫–∏
- `GET /api/leads/:id` - –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–¥–µ–ª–∫–∏ –ø–æ ID
- `PUT /api/leads/:id` - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–¥–µ–ª–∫–∏

### Webhook'–∏ AmoCRM

- `POST /api/amo/webhooks/contact/added` - –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω—Ç–∞–∫—Ç–∞ –≤ AmoCRM
- `POST /api/amo/webhooks/contact/updated` - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç–∞–∫—Ç–∞ –≤ AmoCRM
- `POST /api/amo/webhooks/lead/added` - –°–æ–∑–¥–∞–Ω–∏–µ —Å–¥–µ–ª–∫–∏ –≤ AmoCRM
- `POST /api/amo/webhooks/lead/updated` - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–¥–µ–ª–∫–∏ –≤ AmoCRM

## üîÑ –õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã

### –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω—Ç–∞–∫—Ç–∞/—Å–¥–µ–ª–∫–∏

1. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ –ª–æ–∫–∞–ª—å–Ω–æ–π –ë–î** - –ø–æ–∏—Å–∫ –ø–æ —É–Ω–∏–∫–∞–ª—å–Ω—ã–º –ø–æ–ª—è–º
2. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ AmoCRM** - –ø–æ–∏—Å–∫ –ø–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–º –∫—Ä–∏—Ç–µ—Ä–∏—è–º
3. **–°–æ–∑–¥–∞–Ω–∏–µ –≤ AmoCRM** - –µ—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω
4. **–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ª–æ–∫–∞–ª—å–Ω—É—é –ë–î** - —Å ID –∏–∑ AmoCRM

### –û–±—Ä–∞–±–æ—Ç–∫–∞ webhook'–æ–≤

- **–î–æ–±–∞–≤–ª–µ–Ω–∏–µ**: –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π —Å—É—â–Ω–æ—Å—Ç–∏ –≤ –ª–æ–∫–∞–ª—å–Ω–æ–π –ë–î
- **–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ**: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π —Å—É—â–Ω–æ—Å—Ç–∏ –∏–ª–∏ —Å–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π

## üóÑÔ∏è –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

### –°—Ö–µ–º–∞

- **contacts**: –ö–æ–Ω—Ç–∞–∫—Ç—ã (id, amocrm_id, name, phone, created_at, updated_at)
- **leads**: –°–¥–µ–ª–∫–∏ (id, amocrm_id, name, status, contact_id, created_at, updated_at)

### –ú–∏–≥—Ä–∞—Ü–∏–∏

```bash
# –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π –º–∏–≥—Ä–∞—Ü–∏–∏
npx drizzle-kit generate

# –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π
npx drizzle-kit migrate

# –ü—Ä–æ—Å–º–æ—Ç—Ä —Å—Ö–µ–º—ã
npx drizzle-kit studio
```

## üê≥ Docker

### –°–µ—Ä–≤–∏—Å—ã

- **db**: MySQL 8.0 —Å health check
- **backend**: Node.js –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º–∏ –º–∏–≥—Ä–∞—Ü–∏—è–º–∏
- **nginx**: –ü—Ä–æ–∫—Å–∏-—Å–µ—Ä–≤–µ—Ä –¥–ª—è –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏

### –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã

```bash
# –ü–µ—Ä–µ—Å–±–æ—Ä–∫–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞
docker compose build backend

# –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–∞
docker compose restart backend

# –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞
docker compose logs backend

# –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –æ—á–∏—Å—Ç–∫–∞
docker compose down --volumes --remove-orphans
```

## üîß –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### TypeScript

- `tsconfig.json` - –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–æ–º–ø–∏–ª—è—Ü–∏–∏
- `paths.js` - —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –∞–ª–∏–∞—Å–æ–≤ –≤ runtime
- `prettierrc` - —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞

### Inversify

- `inversify.config.ts` - –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è DI –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
- `inversifyTypes.ts` - —Ç–∏–ø—ã –¥–ª—è –∏–Ω—ä–µ–∫—Ü–∏–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### Webhook'–∏

–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ñ–∞–π–ª `hooks.rest` –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è webhook'–æ–≤:

```bash
# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ REST Client –≤ VS Code
# –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ curl –¥–ª—è –∏–º–∏—Ç–∞—Ü–∏–∏ webhook'–æ–≤
```

### –ü—Ä–∏–º–µ—Ä—ã –∑–∞–ø—Ä–æ—Å–æ–≤

```bash
# –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω—Ç–∞–∫—Ç–∞
curl -X POST http://localhost:3000/api/contacts \
  -H "Content-Type: application/json" \
  -d '{"name":"–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤","phone":"+79001234567"}'

# –ò–º–∏—Ç–∞—Ü–∏—è webhook'–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–Ω—Ç–∞–∫—Ç–∞
curl -X POST http://localhost:3000/api/amo/webhooks/contact/added \
  -H "Content-Type: application/json" \
  -d '{"contacts":{"add":[{"id":123,"name":"–ò–≤–∞–Ω","custom_fields_values":[{"values":[{"value":"+79001234567"}]}]}]}}'
```

## üö® –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –Ω–µ–ø–æ–ª–∞–¥–æ–∫

### –ü—Ä–æ–±–ª–µ–º—ã —Å Docker

```bash
# –û—á–∏—Å—Ç–∫–∞ Docker –∫—ç—à–∞
docker system prune -f

# –ü–µ—Ä–µ—Å–±–æ—Ä–∫–∞ –±–µ–∑ –∫—ç—à–∞
docker compose build --no-cache
```

````

### –ü—Ä–æ–±–ª–µ–º—ã —Å AmoCRM

- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å `AMO_ACCESS_TOKEN`
- –£–±–µ–¥–∏—Ç–µ—Å—å –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç–∏ `AMO_DOMAIN`
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ API

## üìù –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

- **Backend**: –õ–æ–≥–∏ –≤ stdout/stderr (–≤–∏–¥–Ω–æ —á–µ—Ä–µ–∑ `docker compose logs`)
- **–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö**: –õ–æ–≥–∏ MySQL –≤ stdout
- **Nginx**: –õ–æ–≥–∏ –¥–æ—Å—Ç—É–ø–∞ –∏ –æ—à–∏–±–æ–∫

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

- –í—Å–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ `.env` —Ñ–∞–π–ª–µ
- `.env` –¥–æ–±–∞–≤–ª–µ–Ω –≤ `.gitignore`
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤–∞–ª–∏–¥–∞—Ü–∏—è —á–µ—Ä–µ–∑ Zod
- CORS –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ Express.js

## ü§ù –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞

### –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö —Å—É—â–Ω–æ—Å—Ç–µ–π

1. –°–æ–∑–¥–∞—Ç—å –º–æ–¥–µ–ª—å –≤ `src/models/`
2. –°–æ–∑–¥–∞—Ç—å —Å—Ö–µ–º—É –≤ `src/database/schema.ts`
3. –°–æ–∑–¥–∞—Ç—å —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –≤ `src/repositories/`
4. –°–æ–∑–¥–∞—Ç—å —Å–µ—Ä–≤–∏—Å –≤ `src/services/`
5. –°–æ–∑–¥–∞—Ç—å –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä –≤ `src/controllers/`
6. –î–æ–±–∞–≤–∏—Ç—å –≤ DI –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä

### Code Style

```bash
# –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞
npm run format

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
npm run format:check
````

## üìö –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã

- [Drizzle ORM Documentation](https://orm.drizzle.team/)
- [Inversify Documentation](https://inversify.io/)
- [AmoCRM API Documentation](https://www.amocrm.ru/developers)
- [Express.js Documentation](https://expressjs.com/)
